<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Direction Navigator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- THEME VARIABLE DEFINITIONS (3 Schemes) --- */

        /* 1. DEFAULT (Pink / Purple) - Light Mode */
        :root, body[data-theme="default"]:not(.dark-mode) {
            --theme-bg-start: #A855F7; /* Purple */
            --theme-bg-end: #14B8A6; /* Teal */
            --theme-card-bg: white;
            --theme-text: #1F2937;
            --theme-accent: #EC4899; /* Pink */
            --theme-arrow: #14B8A6; /* Teal */
            --theme-secondary: #F3F4F6; /* Gray-100 */
        }
        /* 1. DEFAULT (Pink / Purple) - Dark Mode */
        body[data-theme="default"].dark-mode {
            --theme-bg-start: #4C1D95; /* Deep Purple */
            --theme-bg-end: #064E3B; /* Deep Green */
            --theme-card-bg: #1F2937; /* Gray-800 */
            --theme-text: #E5E7EB; /* Gray-200 */
            --theme-accent: #A855F7; /* Purple */
            --theme-arrow: #34D399; /* Light Teal */
            --theme-secondary: #374151; /* Gray-700 */
        }

        /* 2. TEAL / GREEN Theme - Light Mode */
        body[data-theme="teal"]:not(.dark-mode) {
            --theme-bg-start: #00B8D4; /* Cyan */
            --theme-bg-end: #00C853; /* Bright Green */
            --theme-card-bg: white;
            --theme-text: #1F2937;
            --theme-accent: #00B8D4; /* Cyan */
            --theme-arrow: #00C853; 
            --theme-secondary: #F3F4F6;
        }
        /* 2. TEAL / GREEN Theme - Dark Mode */
        body[data-theme="teal"].dark-mode {
            --theme-bg-start: #006064; /* Dark Cyan */
            --theme-bg-end: #1B5E20; /* Darker Green */
            --theme-card-bg: #1F2937;
            --theme-text: #E5E7EB;
            --theme-accent: #80DEEA; /* Light Cyan */
            --theme-arrow: #A5D6A7; /* Pale Green */
            --theme-secondary: #374151;
        }

        /* 3. BLUE / YELLOW Theme - Light Mode */
        body[data-theme="blue"]:not(.dark-mode) {
            --theme-bg-start: #2196F3; /* Bright Blue */
            --theme-bg-end: #FFEB3B; /* Yellow */
            --theme-card-bg: white;
            --theme-text: #1F2937;
            --theme-accent: #2196F3; 
            --theme-arrow: #FFEB3B;
            --theme-secondary: #F3F4F6;
        }
        /* 3. BLUE / YELLOW Theme - Dark Mode */
        body[data-theme="blue"].dark-mode {
            --theme-bg-start: #0D47A1; /* Deep Blue */
            --theme-bg-end: #FFC107; /* Amber */
            --theme-card-bg: #1F2937;
            --theme-text: #E5E7EB;
            --theme-accent: #90CAF9; /* Light Blue */
            --theme-arrow: #FFECB3; /* Pale Yellow */
            --theme-secondary: #374151;
        }

        /* --- BASE STYLES APPLIED VIA VARIABLES --- */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 16px; 
            transition: background 0.5s ease, color 0.5s ease;
            background: linear-gradient(135deg, var(--theme-bg-start) 0%, var(--theme-bg-end) 50%, var(--theme-bg-end) 100%);
        }

        .card { 
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-out;
            background-color: var(--theme-card-bg); 
            color: var(--theme-text); 
        }

        /* Generic Text/Header Styling */
        body.dark-mode .card h2, body.dark-mode .card label, body.dark-mode .card span { color: var(--theme-text); }
        
        /* Arrow */
        .arrow-container {
            width: 100px;
            height: 100px;
            margin: 20px auto;
        }
        #direction-arrow {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-origin: 50% 50%;
            fill: var(--theme-arrow);
        }
        
        /* Main Button */
        #request-direction { 
            background-color: var(--theme-accent);
            color: white;
            box-shadow: 0 10px 15px -3px var(--theme-accent);
        }
        
        /* Mode/Exit Buttons */
        .mode-button { 
            background-color: rgba(255, 255, 255, 0.3); 
            color: white; 
            transition: all 0.2s;
        }
        .active-mode {
            background-color: var(--theme-accent) !important;
            color: white !important;
        }
        
        /* Settings/Reset Buttons */
        #settings-button { 
            background-color: var(--theme-card-bg); 
            color: var(--theme-accent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .reset-button { 
            background-color: var(--theme-secondary); 
            color: var(--theme-text); 
        }
        
        /* Dark Mode overrides for secondary elements */
        body.dark-mode .mode-button { background-color: rgba(31, 41, 55, 0.7); color: #D1D5DB; }
        body.dark-mode #settings-button { background-color: var(--theme-secondary); color: var(--theme-accent); }
        body.dark-mode .exit-button, body.dark-mode .difficulty-button, body.dark-mode .voice-mode-button { background-color: #4B5563; color: white; }
        
        /* Highlight for selected exit/difficulty/voice button */
        .exit-button.exit-button-active, 
        .difficulty-button.difficulty-button-active,
        .voice-mode-button.voice-mode-button-active {
            background-color: var(--theme-arrow) !important; 
            color: white !important; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transform: scale(1.05);
        }
        
        /* Highlight for selected exit/difficulty/voice button (Dark Mode override) */
        body.dark-mode .exit-button.exit-button-active, 
        body.dark-mode .difficulty-button.difficulty-mode-button-active,
        body.dark-mode .voice-mode-button.voice-mode-button-active { 
            background-color: var(--theme-arrow) !important; 
            color: #1F2937 !important; 
        }
        
        /* Timer Bar Styles */
        #timer-bar-container {
            width: 90%;
            height: 12px;
            margin: 0 auto 1.5rem;
            background-color: var(--theme-secondary);
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background-color: var(--theme-accent);
            transform: translateX(0%);
            transition: transform 0.1s linear; /* Smooth visual update */
        }

        /* Splash Screen (Unchanged, looks great) */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: opacity 0.4s ease;
        }
        .splash-screen-content {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 2.5rem 1.5rem;
            border-radius: 2rem;
            max-width: 90%;
            margin: 24px;
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.5); 
            border: 3px solid var(--theme-accent);
        }
        .welcome-title {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 1rem;
            color: var(--theme-arrow); 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .instructions-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--theme-accent); 
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .instruction-item {
            font-size: 1rem;
            margin-bottom: 0.4rem;
            padding: 0 1rem;
            color: #E5E7EB;
        }
        .click-to-start {
            margin-top: 2rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: #FBBF24;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* --- MODAL STYLES --- */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .settings-modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .settings-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 80%;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 60;
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
        }
        .settings-modal-overlay.open .settings-panel {
            transform: translateY(0);
        }
        
        @media (min-width: 640px) {
            .settings-panel {
                width: 400px;
                right: 0;
                left: auto;
                top: 0;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                border-top-left-radius: 2rem;
                transform: translateX(100%);
                transition: transform 0.4s ease-out;
            }
            .settings-modal-overlay.open .settings-panel {
                transform: translateX(0);
            }
        }
        
        #settings-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 40;
        }
        
        /* Theme Selection Button Styling */
        .theme-select-button {
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            color: white !important; /* Ensure text is visible on colored buttons */
        }
        .theme-select-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .theme-select-button.selected {
            border: 3px solid var(--theme-accent);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
    </style>
</head>
<body data-theme="default">
    
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-screen-content">
            <div class="welcome-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                GPS Training Hub
            </div>
            <p class="text-lg text-gray-300 mb-4">Master quick direction changes without stress.</p>
            
            <div class="instructions-header">HOW TO PLAY:</div>
            <div class="instruction-item">1. **Tap Request** for your driving command.</div>
            <div class="instruction-item">2. Check the **arrow** for the precise turn angle.</div>
            <div class="instruction-item">3. Use the **gear icon** ‚öôÔ∏è for mode changes and settings.</div>
            <div class="click-to-start">TAP ANYWHERE TO START YOUR ENGINE!</div>
        </div>
    </div> <!-- Splash Screen End -->

    <!-- Settings Button (Fixed, Top Right) -->
    <button id="settings-button" class="p-3 rounded-full hover:opacity-80 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09z"></path>
        </svg>
    </button>
    
    <!-- Main App Content -->
    <div id="app" class="w-full max-w-xl opacity-0 transition-opacity duration-500">
        
        <!-- Mode Selector (Stacked on Mobile, Row on Desktop) -->
        <div class="mode-selector mb-6 flex flex-col gap-4 sm:flex-row">
            <button id="mode-junction" class="mode-button flex-1 py-3 px-6 font-bold rounded-2xl shadow-lg transition duration-200 hover:opacity-70" data-mode="junction">
                üöó At Junction
            </button>
            <button id="mode-roundabout" class="mode-button flex-1 py-3 px-6 font-bold rounded-2xl shadow-lg transition duration-200 hover:opacity-70" data-mode="roundabout">
                üõû In Roundabout
            </button>
        </div>

        <!-- Roundabout Exits Input -->
        <div id="roundabout-settings" class="card p-4 mb-6 hidden">
            <label class="block font-semibold mb-3">Select the number of exits:</label>
            <div id="exit-buttons" class="flex justify-between space-x-2">
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="2">2</button>
                <button class="exit-button w-1/5 py-2 exit-button-active bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="3">3</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="4">4</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="5">5</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="6">6</button>
            </div>
            <input type="hidden" id="exits-select" value="3">
        </div>

        <!-- Main Direction Card -->
        <div id="direction-card" class="card text-center mb-6 p-6">
            
            <!-- Timer Bar -->
            <div id="timer-bar-container" class="hidden">
                <div id="timer-bar" style="transform: translateX(0%);"></div>
            </div>

            <p id="direction-text" class="text-3xl sm:text-4xl font-extrabold my-4 h-12 flex items-center justify-center">
                Start Your Engine!
            </p>

            <div class="arrow-container">
                <svg id="direction-arrow" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" transform="rotate(0)">
                    <path d="M16.01 11H4c-1.1 0-2 .9-2 2s.9 2 2 2h12.01v3L21 13l-4.99-4v3z" />
                </svg>
            </div>

            <!-- Main Action Button (Larger for Mobile Touch) -->
            <button id="request-direction" class="w-full py-5 mt-4 text-white font-black text-2xl rounded-2xl shadow-xl transition duration-200 hover:opacity-90 active:scale-[0.98] focus:outline-none focus:ring-4" style="--tw-ring-color: var(--theme-accent);">
                üéØ Request Direction
            </button>
        </div>
        
        <!-- Recent Directions History -->
        <div class="card p-4">
            <h2 class="text-xl font-bold mb-3 border-b pb-2">Recent Directions</h2>
            <ul id="history-list" class="space-y-2">
                <li class="italic text-sm">No directions yet.</li>
            </ul>
        </div>

        <!-- Status Message Box (Replaced alert()) -->
        <div id="status-message" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
            <div class="card p-6 text-center max-w-sm">
                <p id="status-text" class="text-xl font-semibold mb-4"></p>
                <button onclick="document.getElementById('status-message').style.display='none'" class="bg-pink-500 text-white py-2 px-6 rounded-full font-bold hover:bg-pink-600 transition">OK</button>
            </div>
        </div>
        
        <!-- Settings Modal/Panel -->
        <div id="settings-modal-overlay" class="settings-modal-overlay" onclick="closeSettingsModal()">
            <div id="settings-panel" class="settings-panel card p-6 overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Game Settings</h2>
                    <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" onclick="closeSettingsModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <!-- Reset Button -->
                <button id="reset-game" class="reset-button w-full py-3 mb-6 font-semibold rounded-2xl shadow-md transition duration-200 hover:opacity-80 active:scale-[0.98]">
                    üîÑ Reset Game
                </button>

                <!-- NEW: Difficulty/Timer Settings -->
                <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Challenge Level (Timer)</p>
                <div id="difficulty-buttons" class="flex justify-between space-x-2 mt-3 mb-6">
                    <button class="difficulty-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-difficulty="easy">Easy</button>
                    <button class="difficulty-button flex-1 py-2 difficulty-button-active bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-difficulty="medium">Medium</button>
                    <button class="difficulty-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-difficulty="hard">Hard</button>
                    <button class="difficulty-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-difficulty="off">Off</button>
                </div>
                <input type="hidden" id="difficulty-select" value="medium">

                <!-- NEW: Audio Settings -->
                <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Audio Mode</p>
                <div id="voice-mode-buttons" class="flex justify-between space-x-2 mt-3 mb-6">
                    <button class="voice-mode-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-mode="off">No Sound</button>
                    <button class="voice-mode-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-mode="basic">Basic Sounds</button>
                    <button class="voice-mode-button flex-1 py-2 voice-mode-button-active bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-mode="advanced">Advanced GPS</button>
                </div>
                <input type="hidden" id="voice-mode-select" value="advanced">

                <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Appearance</p>
                <!-- Theme Selector Buttons -->
                <div class="flex flex-wrap gap-3 mt-3 mb-6" id="theme-selector-buttons">
                    <!-- Buttons will be generated by JS -->
                </div>

                <div class="flex justify-between items-center pt-4">
                    <label for="dark-mode-toggle" class="select-none">üåë Dark Mode</label>
                    <input type="checkbox" id="dark-mode-toggle" class="h-6 w-6 rounded text-pink-500 focus:ring-pink-500" style="--tw-ring-color: var(--theme-accent);">
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- FIREBASE GLOBALS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- GAME STATE ---
        let mode = 'junction'; 
        let exits = 3; 
        let recentDirections = [null, null]; 
        let history = [];
        let hasStarted = false; 
        let colorTheme = 'default'; 
        let isDarkMode = false; 
        let userId = null; 
        let isAudioAllowed = false; // NEW: Flag to control audio playback permission

        // --- TIMER STATE ---
        let difficulty = 'medium'; 
        let timerDuration = 4000; // Default: 4 seconds
        let timerInterval = null;
        let timeRemaining = 0;
        let timerStartTime = 0;
        const TIMER_STEPS = 50; 

        const DIFFICULTY_MAP = {
            'easy': 6000, 
            'medium': 4000,
            'hard': 2500,
            'off': 0
        };

        // --- AUDIO STATE ---
        let voiceMode = 'advanced'; // Default to advanced
        let audioContext = null;
        let audioPlayer = new Audio(); // Reusable audio element for advanced mode

        // --- AUDIO FILE MAPPING (Uses user's local files in the sounds folder) ---
        // NOTE: The file paths assume a 'sounds/' directory or files in the root for testing.
        const advancedAudioFiles = {
            'engine': 'engine-start.mp3',
            'horn': 'beep.mp3', // Used for interrupts/times up
            'straight': 'gps-straight.mp3',
            'left': 'gps-left.mp3',
            'right': 'gps-right.mp3',
            'exit-1': 'gps-exit-1.mp3',
            'exit-2': 'gps-exit-2.mp3',
            'exit-3': 'gps-exit-3.mp3',
            'exit-4': 'gps-exit-4.mp3',
            'exit-5': 'gps-exit-5.mp3',
            'exit-6': 'gps-exit-5.mp3' // Fallback for 6th exit, using 5th exit sound
        };

        // --- THEME MAPPING ---
        const themeColors = {
            'default': { name: 'Pink/Teal', dark: 'bg-purple-700', light: 'bg-pink-500' },
            'teal': { name: 'Teal/Green', dark: 'bg-green-700', light: 'bg-cyan-500' },
            'blue': { name: 'Blue/Yellow', dark: 'bg-yellow-700', light: 'bg-blue-500' },
        };
        
        // --- UI ELEMENTS ---
        const ui = {
            splashScreen: document.getElementById('splashScreen'),
            appContainer: document.getElementById('app'),
            settingsButton: document.getElementById('settings-button'),
            settingsModalOverlay: document.getElementById('settings-modal-overlay'),
            modeJunction: document.getElementById('mode-junction'),
            modeRoundabout: document.getElementById('mode-roundabout'),
            roundaboutSettings: document.getElementById('roundabout-settings'),
            exitsSelect: document.getElementById('exits-select'),
            exitButtons: document.getElementById('exit-buttons'),
            requestDirection: document.getElementById('request-direction'),
            directionText: document.getElementById('direction-text'),
            directionArrow: document.getElementById('direction-arrow'),
            historyList: document.getElementById('history-list'),
            statusMessage: document.getElementById('status-message'),
            statusText: document.getElementById('status-text'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            themeSelectorButtons: document.getElementById('theme-selector-buttons'),
            resetGameButton: document.getElementById('reset-game'),
            timerBarContainer: document.getElementById('timer-bar-container'),
            timerBar: document.getElementById('timer-bar'),
            difficultyButtons: document.getElementById('difficulty-buttons'),
            difficultySelect: document.getElementById('difficulty-select'),
            voiceModeButtons: document.getElementById('voice-mode-buttons'),
            voiceModeSelect: document.getElementById('voice-mode-select')
        };
        
        // --- UTILITY FUNCTIONS ---
        
        function getThemeAccentColor(themeKey) {
            const tempDiv = document.createElement('div');
            tempDiv.setAttribute('data-theme', themeKey);
            if (document.body) document.body.appendChild(tempDiv);
            if (isDarkMode) { tempDiv.classList.add('dark-mode'); }
            const color = getComputedStyle(tempDiv).getPropertyValue('--theme-accent').trim();
            if (document.body) document.body.removeChild(tempDiv);
            return color;
        }

        function showStatusMessage(message) {
            ui.statusText.textContent = message;
            ui.statusMessage.style.display = 'flex';
        }

        // --- AUDIO FUNCTIONS ---

        function initializeAudioContext() {
            // Must be called as a result of a user interaction (e.g., button click)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("Audio Context Initialized.");
            }
        }

        function stopCurrentAudio() {
            // Stop HTML5 Audio Player (for Advanced Mode)
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
        }

        // Function to generate a simple beep using Web Audio API (Basic Mode)
        function playBasicSound(frequency = 440, duration = 0.2, type = 'sine') {
            if (voiceMode !== 'basic' || !isAudioAllowed) return; // Added isAudioAllowed check
            
            // initializeAudioContext is now called on splash screen click
            if (!audioContext) return; 

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Plays audio using MP3 files (Advanced Mode)
        function playAdvancedSound(key) {
            if (voiceMode !== 'advanced' || !isAudioAllowed) return; // Added isAudioAllowed check

            const fileName = advancedAudioFiles[key];
            if (!fileName) {
                console.warn(`Audio file not mapped for key: ${key}`);
                return;
            }
            stopCurrentAudio();
            // Assuming files are available in the root path or 'sounds/'
            audioPlayer.src = fileName;
            // The initial play() call is now safe because isAudioAllowed is set on click
            audioPlayer.play().catch(e => {
                console.error("Error playing audio:", e);
                // If the error persists, warn the user they need a specific interaction
                if (e.name === 'NotAllowedError' && !audioPlayer.wasInteracted) {
                    showStatusMessage("Audio playback blocked. Please try clicking the 'Request Direction' button once.");
                    audioPlayer.wasInteracted = true;
                }
            });
        }
        
        // Main function to decide which audio to play
        function playAudio(action, value = null) {
            // Check if sound is explicitly off OR if we haven't received permission yet
            if (voiceMode === 'off' || !isAudioAllowed) {
                return;
            } else if (voiceMode === 'advanced') {
                switch(action) {
                    // Engine sound is only played on user-initiated mode change
                    case 'engine': playAdvancedSound('engine'); break;
                    case 'horn': playAdvancedSound('horn'); break;
                    case 'direction':
                        if (mode === 'junction') {
                            const directionKey = value.toLowerCase().replace(/\s/g, '');
                            playAdvancedSound(directionKey);
                        } else if (mode === 'roundabout') {
                            // value is the exit number (1, 2, 3, etc.)
                            const exitKey = `exit-${value}`;
                            playAdvancedSound(exitKey);
                        }
                        break;
                }
            } else if (voiceMode === 'basic') {
                // Basic sounds are simple beeps and tones
                switch(action) {
                    case 'engine': playBasicSound(200, 0.5, 'square'); break;
                    case 'horn': playBasicSound(800, 0.1, 'sawtooth'); break; // High pitch, short for interruption
                    case 'direction':
                        // Different frequency for different turns
                        let freq = 440; // Default
                        if (mode === 'junction') {
                            if (value === 'Left' || value.includes('Left')) freq = 300;
                            else if (value === 'Right' || value.includes('Right')) freq = 600;
                        }
                        playBasicSound(freq, 0.4, 'sine');
                        break;
                }
            }
        }

        // --- TIMER LOGIC ---

        function startTimer() {
            if (timerDuration === 0) {
                ui.timerBarContainer.classList.add('hidden');
                return;
            }

            // Interrupt any existing timer
            clearInterval(timerInterval);
            stopCurrentAudio(); 
            
            ui.timerBarContainer.classList.remove('hidden');
            timeRemaining = timerDuration;
            timerStartTime = Date.now();

            ui.timerBar.style.backgroundColor = 'var(--theme-accent)';
            ui.timerBar.style.transform = 'translateX(0%)';

            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - timerStartTime;
                timeRemaining = timerDuration - elapsedTime;
                
                const percentageRemaining = (timeRemaining / timerDuration) * 100;

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                    return;
                }

                // Update bar visual
                ui.timerBar.style.transform = `translateX(-${100 - percentageRemaining}%)`;

                // Change color when low
                if (percentageRemaining < 30) {
                    ui.timerBar.style.backgroundColor = '#EF4444'; // Red
                } else if (percentageRemaining < 60) {
                    ui.timerBar.style.backgroundColor = '#F59E0B'; // Amber
                }

            }, TIMER_STEPS);
        }

        function clearTimer() {
            clearInterval(timerInterval);
            ui.timerBarContainer.classList.add('hidden');
        }

        function handleTimeout() {
            clearTimer();
            ui.directionText.textContent = "TIME'S UP! üõë";
            playAudio('horn'); // Use horn sound for time out
        }

        // --- MAIN GAME LOGIC ---

        function generateJunctionDirection() {
            const directions = ['Straight Ahead', 'Turn Left', 'Turn Right', 'Slight Left', 'Slight Right', 'U-Turn'];
            const angles = {
                'Straight Ahead': 0,
                'Turn Left': -90,
                'Turn Right': 90,
                'Slight Left': -45,
                'Slight Right': 45,
                'U-Turn': 180
            };

            let newDirection;
            do {
                newDirection = directions[Math.floor(Math.random() * directions.length)];
            } while (newDirection === recentDirections[0]); // Ensure direction changes

            recentDirections.unshift(newDirection);
            recentDirections.pop();

            ui.directionText.textContent = newDirection;
            ui.directionArrow.style.transform = `rotate(${angles[newDirection]}deg)`;
            
            // Play audio
            playAudio('direction', newDirection);
            
            // Start timer if enabled
            startTimer();

            return newDirection;
        }

        function generateRoundaboutDirection() {
            const maxExits = parseInt(ui.exitsSelect.value);
            const exitNumber = Math.floor(Math.random() * maxExits) + 1;
            
            let directionText;
            if (exitNumber === 1) {
                directionText = `Take the 1st Exit (Left)`;
            } else if (exitNumber === maxExits && maxExits > 2) {
                directionText = `Take the ${exitNumber}th Exit (Right)`;
            } else if (exitNumber === 2 && maxExits === 2) {
                directionText = `Take the 2nd Exit (Straight)`;
            } else {
                directionText = `Take the ${exitNumber}${exitNumber === 2 ? 'nd' : (exitNumber === 3 ? 'rd' : 'th')} Exit`;
            }
            
            // Calculate rotation angle (0 is straight/default exit angle)
            let rotationAngle;
            
            if (maxExits === 3) {
                // Exit 1: -120 deg (Left), Exit 2: 0 deg (Straight), Exit 3: 120 deg (Right)
                rotationAngle = (exitNumber - 2) * 120;
            } else if (maxExits === 4) {
                // Simpler angles: 1: -120, 2: 0, 3: 120, 4: 180
                rotationAngle = { 1: -120, 2: 0, 3: 120, 4: 180 }[exitNumber] || 0;
            } else {
                // Fallback to simpler left/right mapping
                if (exitNumber === 1) rotationAngle = -90;
                else if (exitNumber === 2) rotationAngle = 0;
                else if (exitNumber >= 3) rotationAngle = 90;
            }

            recentDirections.unshift(directionText);
            recentDirections.pop();

            ui.directionText.textContent = directionText;
            ui.directionArrow.style.transform = `rotate(${rotationAngle}deg)`;
            
            // Play audio
            playAudio('direction', exitNumber);

            // Start timer if enabled
            startTimer();
            
            return directionText;
        }

        function updateHistory(newDirection) {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            history.unshift({ time: timestamp, direction: newDirection });
            
            // Trim history to 5 items
            if (history.length > 5) {
                history.pop();
            }

            renderHistory();
        }

        function renderHistory() {
            ui.historyList.innerHTML = '';
            if (history.length === 0) {
                ui.historyList.innerHTML = '<li class="italic text-sm">No directions yet.</li>';
                return;
            }

            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'text-sm font-medium';
                li.innerHTML = `<span class="font-bold text-xs p-1 rounded-md" style="background-color: var(--theme-secondary);">[${item.time}]</span> ${item.direction}`;
                ui.historyList.appendChild(li);
            });
        }
        
        function resetGame() {
            clearTimer();
            history = [];
            recentDirections = [null, null];
            ui.directionText.textContent = "Game Reset. Tap Request.";
            ui.directionArrow.style.transform = `rotate(0deg)`;
            renderHistory();
        }

        // --- HANDLERS ---

        function handleRequestDirection() {
            if (!hasStarted) {
                showStatusMessage("Please select a mode (At Junction / In Roundabout) to begin!");
                return;
            }
            
            let newDirection;
            if (mode === 'junction') {
                newDirection = generateJunctionDirection();
            } else {
                newDirection = generateRoundaboutDirection();
            }

            updateHistory(newDirection);
        }

        function handleModeChange(newMode) {
            mode = newMode;
            // Update active state for buttons
            ui.modeJunction.classList.remove('active-mode');
            ui.modeRoundabout.classList.remove('active-mode');
            
            if (mode === 'junction') {
                ui.modeJunction.classList.add('active-mode');
                ui.roundaboutSettings.classList.add('hidden');
                ui.directionText.textContent = "Junction Mode Ready";
            } else {
                ui.modeRoundabout.classList.add('active-mode');
                ui.roundaboutSettings.classList.remove('hidden');
                ui.directionText.textContent = "Roundabout Mode Ready";
            }
            
            if (!hasStarted) {
                hasStarted = true;
                ui.appContainer.style.opacity = '1';
                // NOTE: playAudio('engine') is removed here to prevent the NotAllowedError.
                // It is implicitly started by the user interaction when isAudioAllowed is set.
            }
            resetGame();
        }
        
        function handleExitSelection(event) {
            const button = event.target.closest('.exit-button');
            if (!button) return;

            // Remove active class from all
            ui.exitButtons.querySelectorAll('.exit-button').forEach(btn => btn.classList.remove('exit-button-active'));
            // Add active class to clicked button
            button.classList.add('exit-button-active');
            
            exits = parseInt(button.dataset.exits);
            ui.exitsSelect.value = exits; // Update hidden input
            resetGame();
        }
        
        function handleDifficultySelection(event) {
            const button = event.target.closest('.difficulty-button');
            if (!button) return;

            // Remove active class from all
            ui.difficultyButtons.querySelectorAll('.difficulty-button').forEach(btn => btn.classList.remove('difficulty-button-active'));
            // Add active class to clicked button
            button.classList.add('difficulty-button-active');
            
            difficulty = button.dataset.difficulty;
            ui.difficultySelect.value = difficulty; // Update hidden input
            
            // Set new duration
            timerDuration = DIFFICULTY_MAP[difficulty];
            
            // If timer is off, hide the bar immediately
            if (timerDuration === 0) {
                clearTimer();
            } else if (timerInterval) {
                // If the game is mid-play, clear and restart the timer with new duration
                clearInterval(timerInterval);
                // The next call to handleRequestDirection will restart it
            }
        }
        
        function handleVoiceModeSelection(event) {
            const button = event.target.closest('.voice-mode-button');
            if (!button) return;

            // Remove active class from all
            ui.voiceModeButtons.querySelectorAll('.voice-mode-button').forEach(btn => btn.classList.remove('voice-mode-button-active'));
            // Add active class to clicked button
            button.classList.add('voice-mode-button-active');
            
            voiceMode = button.dataset.mode;
            ui.voiceModeSelect.value = voiceMode;
            localStorage.setItem('voiceMode', voiceMode);
            stopCurrentAudio(); // Stop any currently playing audio if mode changes
        }

        // --- APPEARANCE & SETTINGS ---

        function openSettingsModal() {
            ui.settingsModalOverlay.classList.add('open');
        }

        function closeSettingsModal() {
            ui.settingsModalOverlay.classList.remove('open');
        }

        function toggleDarkMode(isDark) {
            isDarkMode = isDark;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
        }

        function changeTheme(themeKey) {
            colorTheme = themeKey;
            document.body.setAttribute('data-theme', themeKey);
            localStorage.setItem('colorTheme', themeKey);
            
            // Update selection visuals
            ui.themeSelectorButtons.querySelectorAll('.theme-select-button').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.theme === themeKey) {
                    btn.classList.add('selected');
                }
            });
        }
        
        function generateThemeButtons() {
            ui.themeSelectorButtons.innerHTML = '';
            Object.keys(themeColors).forEach(key => {
                const colors = themeColors[key];
                const button = document.createElement('button');
                button.className = `theme-select-button py-2 px-4 rounded-xl font-bold transition duration-150 hover:opacity-80`;
                button.dataset.theme = key;
                button.textContent = colors.name;
                
                // Set background color for preview, using the light mode start color for simplicity
                const lightColor = getThemeAccentColor(key); 
                button.style.backgroundColor = lightColor;
                
                if (key === colorTheme) {
                    button.classList.add('selected');
                }
                
                button.addEventListener('click', () => changeTheme(key));
                ui.themeSelectorButtons.appendChild(button);
            });
        }
        
        // --- INITIALIZATION ---

        function loadPreferences() {
            // Load Dark Mode
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            ui.darkModeToggle.checked = savedDarkMode;
            toggleDarkMode(savedDarkMode);

            // Load Theme
            const savedTheme = localStorage.getItem('colorTheme') || 'default';
            changeTheme(savedTheme);
            
            // Load Difficulty
            const savedDifficulty = localStorage.getItem('difficulty') || 'medium';
            difficulty = savedDifficulty;
            timerDuration = DIFFICULTY_MAP[difficulty];
            ui.difficultySelect.value = difficulty;
            ui.difficultyButtons.querySelectorAll('.difficulty-button').forEach(btn => {
                btn.classList.toggle('difficulty-button-active', btn.dataset.difficulty === difficulty);
            });

            // Load Voice Mode
            const savedVoiceMode = localStorage.getItem('voiceMode') || 'advanced';
            voiceMode = savedVoiceMode;
            ui.voiceModeSelect.value = voiceMode;
            ui.voiceModeButtons.querySelectorAll('.voice-mode-button').forEach(btn => {
                btn.classList.toggle('voice-mode-button-active', btn.dataset.mode === voiceMode);
            });
            
            // Set initial mode to junction. No sound played here.
            handleModeChange('junction');
            
            generateThemeButtons(); // Generate theme buttons after loading theme
        }

        function setupEventListeners() {
            ui.splashScreen.addEventListener('click', () => {
                // 1. This is the first user interaction. Initialize audio here.
                initializeAudioContext();
                isAudioAllowed = true;
                
                // 2. Play initial engine sound if in a sound mode
                if (voiceMode !== 'off') {
                    playAudio('engine');
                }

                // 3. Dismiss splash screen
                ui.splashScreen.style.opacity = '0';
                setTimeout(() => ui.splashScreen.style.display = 'none', 400);
            });

            ui.requestDirection.addEventListener('click', handleRequestDirection);
            
            ui.modeJunction.addEventListener('click', () => handleModeChange('junction'));
            ui.modeRoundabout.addEventListener('click', () => handleModeChange('roundabout'));
            
            ui.exitButtons.addEventListener('click', handleExitSelection);
            
            ui.settingsButton.addEventListener('click', openSettingsModal);
            ui.resetGameButton.addEventListener('click', () => {
                resetGame();
                closeSettingsModal();
            });

            ui.darkModeToggle.addEventListener('change', (e) => toggleDarkMode(e.target.checked));
            
            // New Listeners for settings
            ui.difficultyButtons.addEventListener('click', handleDifficultySelection);
            ui.voiceModeButtons.addEventListener('click', handleVoiceModeSelection);
        }

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Running without persistence.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid;
                console.log("Firebase initialized. User ID:", userId || 'Anonymous');

            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }
        
        window.onload = function() {
            // Check if AudioContext is supported early
            if (!(window.AudioContext || window.webkitAudioContext)) {
                showStatusMessage("Your browser does not fully support Web Audio. Sound features may be limited or unavailable.");
            }
            
            loadPreferences();
            setupEventListeners();
            initFirebase(); 
            // Initial opacity is 0, will be set to 1 on first mode selection (hasStarted=true)
        };
        
        // Expose function for the button outside the module scope
        window.closeSettingsModal = closeSettingsModal;

    </script>
</body>
</html>
