<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Direction Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- THEME VARIABLE DEFINITIONS (3 Schemes) --- */

        /* 1. DEFAULT (Pink / Purple) - Light Mode */
        :root, body[data-theme="default"]:not(.dark-mode) {
            --theme-bg-start: #A855F7; /* Purple */
            --theme-bg-end: #14B8A6; /* Teal */
            --theme-card-bg: white;
            --theme-text: #1F2937;
            --theme-accent: #EC4899; /* Pink */
            --theme-arrow: #14B8A6; /* Teal */
            --theme-secondary: #F3F4F6; /* Gray-100 */
        }
        /* 1. DEFAULT (Pink / Purple) - Dark Mode */
        body[data-theme="default"].dark-mode {
            --theme-bg-start: #4C1D95; /* Deep Purple */
            --theme-bg-end: #064E3B; /* Deep Green */
            --theme-card-bg: #1F2937; /* Gray-800 */
            --theme-text: #E5E7EB; /* Gray-200 */
            --theme-accent: #A855F7; /* Purple */
            --theme-arrow: #34D399; /* Light Teal */
            --theme-secondary: #374151; /* Gray-700 */
        }

        /* 2. TEAL / GREEN Theme - Light Mode */
        body[data-theme="teal"]:not(.dark-mode) {
            --theme-bg-start: #00B8D4; /* Cyan */
            --theme-bg-end: #00C853; /* Bright Green */
            --theme-card-bg: white;
            --theme-text: #1F2937;
            --theme-accent: #00B8D4; /* Cyan */
            --theme-arrow: #00C853; 
            --theme-secondary: #F3F4F6;
        }
        /* 2. TEAL / GREEN Theme - Dark Mode */
        body[data-theme="teal"].dark-mode {
            --theme-bg-start: #006064; /* Dark Cyan */
            --theme-bg-end: #1B5E20; /* Darker Green */
            --theme-card-bg: #1F2937;
            --theme-text: #E5E7EB;
            --theme-accent: #80DEEA; /* Light Cyan */
            --theme-arrow: #A5D6A7; /* Pale Green */
            --theme-secondary: #374151;
        }

        /* 3. BLUE / YELLOW Theme - Light Mode */
        body[data-theme="blue"]:not(.dark-mode) {
            --theme-bg-start: #2196F3; /* Bright Blue */
            --theme-bg-end: #FFEB3B; /* Yellow */
            --theme-card-bg: white;
            --theme-text: #1F2937;
            --theme-accent: #2196F3; 
            --theme-arrow: #FFEB3B;
            --theme-secondary: #F3F4F6;
        }
        /* 3. BLUE / YELLOW Theme - Dark Mode */
        body[data-theme="blue"].dark-mode {
            --theme-bg-start: #0D47A1; /* Deep Blue */
            --theme-bg-end: #FFC107; /* Amber */
            --theme-card-bg: #1F2937;
            --theme-text: #E5E7EB;
            --theme-accent: #90CAF9; /* Light Blue */
            --theme-arrow: #FFECB3; /* Pale Yellow */
            --theme-secondary: #374151;
        }

        /* --- BASE STYLES APPLIED VIA VARIABLES --- */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 16px; 
            transition: background 0.5s ease, color 0.5s ease;
            background: linear-gradient(135deg, var(--theme-bg-start) 0%, var(--theme-bg-end) 50%, var(--theme-bg-end) 100%);
        }

        .card { 
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-out;
            background-color: var(--theme-card-bg); 
            color: var(--theme-text); 
        }

        /* Generic Text/Header Styling */
        body.dark-mode .card h2, body.dark-mode .card label, body.dark-mode .card span { color: var(--theme-text); }
        
        /* Arrow */
        .arrow-container {
            width: 100px;
            height: 100px;
            margin: 20px auto;
        }
        #direction-arrow {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-origin: 50% 50%;
            fill: var(--theme-arrow);
        }
        
        /* Main Button */
        #request-direction { 
            background-color: var(--theme-accent);
            color: white;
            box-shadow: 0 10px 15px -3px var(--theme-accent);
        }
        
        /* Mode/Exit Buttons */
        .mode-button { 
            background-color: rgba(255, 255, 255, 0.3); 
            color: white; 
            transition: all 0.2s;
        }
        .active-mode {
            background-color: var(--theme-accent) !important;
            color: white !important;
        }
        
        /* Settings/Reset Buttons */
        #settings-button { 
            background-color: var(--theme-card-bg); 
            color: var(--theme-accent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .reset-button { 
            background-color: var(--theme-secondary); 
            color: var(--theme-text); 
        }
        
        /* Dark Mode overrides for secondary elements */
        body.dark-mode .mode-button { background-color: rgba(31, 41, 55, 0.7); color: #D1D5DB; }
        body.dark-mode #settings-button { background-color: var(--theme-secondary); color: var(--theme-accent); }
        body.dark-mode .exit-button { background-color: #4B5563; color: white; }
        body.dark-mode .exit-button-active { background-color: var(--theme-arrow) !important; color: #1F2937 !important; }
        
        /* Splash Screen (Unchanged, looks great) */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: opacity 0.4s ease;
        }
        .splash-screen-content {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 2.5rem 1.5rem;
            border-radius: 2rem;
            max-width: 90%;
            margin: 24px;
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.5); 
            border: 3px solid var(--theme-accent);
        }
        .welcome-title {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 1rem;
            color: var(--theme-arrow); 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .instructions-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--theme-accent); 
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .instruction-item {
            font-size: 1rem;
            margin-bottom: 0.4rem;
            padding: 0 1rem;
            color: #E5E7EB;
        }
        .click-to-start {
            margin-top: 2rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: #FBBF24;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* --- MODAL STYLES --- */
        .settings-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .settings-modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .settings-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 80%;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 60;
            border-top-left-radius: 2rem;
            border-top-right-radius: 2rem;
        }
        .settings-modal-overlay.open .settings-panel {
            transform: translateY(0);
        }
        
        @media (min-width: 640px) {
            .settings-panel {
                width: 400px;
                right: 0;
                left: auto;
                top: 0;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                border-top-left-radius: 2rem;
                transform: translateX(100%);
                transition: transform 0.4s ease-out;
            }
            .settings-modal-overlay.open .settings-panel {
                transform: translateX(0);
            }
        }
        
        #settings-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 40;
        }
        
        /* Theme Selection Button Styling */
        .theme-select-button {
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            color: white !important; /* Ensure text is visible on colored buttons */
        }
        .theme-select-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .theme-select-button.selected {
            border: 3px solid var(--theme-accent);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
    </style>
</head>
<body data-theme="default">
    
    <div class="splash-screen" id="splashScreen">
        <div class="splash-screen-content">
            <div class="welcome-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                GPS Training Hub
            </div>
            <p class="text-lg text-gray-300 mb-4">Master quick direction changes without stress.</p>
            
            <div class="instructions-header">HOW TO PLAY:</div>
            <div class="instruction-item">1. **Tap Request** for your driving command.</div>
            <div class="instruction-item">2. Check the **arrow** for the precise turn angle.</div>
            <div class="instruction-item">3. Use the **gear icon** ‚öôÔ∏è for mode changes and settings.</div>
            <div class="click-to-start">TAP ANYWHERE TO START YOUR ENGINE!</div>
        </div>
    </div> <button id="settings-button" class="p-3 rounded-full hover:opacity-80 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09z"></path>
        </svg>
    </button>
    
    <div id="app" class="w-full max-w-xl opacity-0 transition-opacity duration-500">
        
        <div class="mode-selector mb-6 flex flex-col gap-4 sm:flex-row">
            <button id="mode-junction" class="mode-button flex-1 py-3 px-6 font-bold rounded-2xl shadow-lg transition duration-200 hover:opacity-70" data-mode="junction">
                üöó At Junction
            </button>
            <button id="mode-roundabout" class="mode-button flex-1 py-3 px-6 font-bold rounded-2xl shadow-lg transition duration-200 hover:opacity-70" data-mode="roundabout">
                üõû In Roundabout
            </button>
        </div>

        <div id="roundabout-settings" class="card p-4 mb-6 hidden">
            <label class="block font-semibold mb-3">Select the number of exits:</label>
            <div id="exit-buttons" class="flex justify-between space-x-2">
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="2">2</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="3">3</button>
                <button class="exit-button w-1/5 py-2 exit-button-active bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="4">4</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="5">5</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="6">6</button>
            </div>
            <input type="hidden" id="exits-select" value="4">
        </div>

        <div id="direction-card" class="card text-center mb-6 p-6">
            <p id="direction-text" class="text-3xl sm:text-4xl font-extrabold my-4 h-12 flex items-center justify-center">
                Start Your Engine!
            </p>

            <div class="arrow-container">
                <svg id="direction-arrow" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" transform="rotate(0)">
                    <path d="M16.01 11H4c-1.1 0-2 .9-2 2s.9 2 2 2h12.01v3L21 13l-4.99-4v3z" />
                </svg>
            </div>

            <button id="request-direction" class="w-full py-5 mt-4 text-white font-black text-2xl rounded-2xl shadow-xl transition duration-200 hover:opacity-90 active:scale-[0.98] focus:outline-none focus:ring-4" style="--tw-ring-color: var(--theme-accent);">
                üéØ Request Direction
            </button>
        </div>
        
        <div class="card p-4">
            <h2 class="text-xl font-bold mb-3 border-b pb-2">Recent Directions</h2>
            <ul id="history-list" class="space-y-2">
                <li class="italic text-sm">No directions yet.</li>
            </ul>
        </div>

        <div id="status-message" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
            <div class="card p-6 text-center max-w-sm">
                <p id="status-text" class="text-xl font-semibold mb-4"></p>
                <button onclick="document.getElementById('status-message').style.display='none'" class="bg-pink-500 text-white py-2 px-6 rounded-full font-bold hover:bg-pink-600 transition">OK</button>
            </div>
        </div>
        
        <div id="settings-modal-overlay" class="settings-modal-overlay" onclick="closeSettingsModal()">
            <div id="settings-panel" class="settings-panel card p-6 overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Game Settings</h2>
                    <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" onclick="closeSettingsModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <button id="reset-game" class="reset-button w-full py-3 mb-6 font-semibold rounded-2xl shadow-md transition duration-200 hover:opacity-80 active:scale-[0.98]">
                    üîÑ Reset Game
                </button>

                <div class="space-y-4 text-base">
                    
                    <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Appearance</p>
                    <div class="flex flex-wrap gap-3" id="theme-selector-buttons">
                        </div>

                    <div class="flex justify-between items-center pt-4">
                        <label for="dark-mode-toggle" class="select-none">üåë Dark Mode</label>
                        <input type="checkbox" id="dark-mode-toggle" class="h-6 w-6 rounded text-pink-500 focus:ring-pink-500" style="--tw-ring-color: var(--theme-accent);">
                    </div>
                    
                    <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Audio Controls</p>
                    <div class="flex justify-between items-center">
                        <label for="voice-toggle" class="select-none">üó£Ô∏è GPS Voice Guidance</label>
                        <input type="checkbox" id="voice-toggle" class="h-6 w-6 rounded focus:ring-pink-500" style="--tw-ring-color: var(--theme-accent);">
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="horn-toggle" class="select-none">üì¢ Horn Feedback (On Interrupt)</label>
                        <input type="checkbox" id="horn-toggle" class="h-6 w-6 rounded focus:ring-pink-500" style="--tw-ring-color: var(--theme-accent);">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- GAME STATE ---
        let mode = 'junction'; // 'junction' or 'roundabout'
        let exits = 4;
        let recentDirections = [null, null]; // [most recent, second most recent]
        let history = [];
        let isSpeaking = false; 
        let hasStarted = false; 
        let colorTheme = 'default'; // Added theme state
        let isDarkMode = false; // Added dark mode state


        // --- THEME MAPPING (Used for button generation) ---
        const themeColors = {
            'default': { name: 'Pink/Teal', light: 'bg-pink-500', dark: 'bg-purple-700' },
            'teal': { name: 'Teal/Green', light: 'bg-cyan-500', dark: 'bg-green-700' },
            'blue': { name: 'Blue/Yellow', light: 'bg-blue-500', dark: 'bg-yellow-700' },
        };
        
        // Helper to dynamically get the CSS variable-defined accent color for buttons
        function getThemeAccentColor(themeKey) {
            const tempDiv = document.createElement('div');
            tempDiv.setAttribute('data-theme', themeKey);
            // Temporarily append to body to read styles
            document.body.appendChild(tempDiv);
            
            // Temporarily switch dark mode class if needed
            if (isDarkMode) {
                tempDiv.classList.add('dark-mode');
            }
            
            // Read the CSS variable
            const color = getComputedStyle(tempDiv).getPropertyValue('--theme-accent').trim();
            
            // Clean up
            document.body.removeChild(tempDiv);
            
            return color;
        }


        // --- AUDIO FILE MAPPING ---
        const audioFiles = {
            'engine': 'engine-start.mp3',
            'horn': 'beep.mp3',
            'straight': 'gps-straight.mp3',
            'left': 'gps-left.mp3',
            'right': 'gps-right.mp3',
            'exit-1': 'gps-exit-1.mp3',
            'exit-2': 'gps-exit-2.mp3',
            'exit-3': 'gps-exit-3.mp3',
            'exit-4': 'gps-exit-4.mp3',
            'exit-5': 'gps-exit-5.mp3',
        };

        // --- UI ELEMENTS ---
        const ui = {
            splashScreen: document.getElementById('splashScreen'),
            appContainer: document.getElementById('app'),
            settingsButton: document.getElementById('settings-button'),
            settingsModalOverlay: document.getElementById('settings-modal-overlay'),
            modeJunction: document.getElementById('mode-junction'),
            modeRoundabout: document.getElementById('mode-roundabout'),
            roundaboutSettings: document.getElementById('roundabout-settings'),
            exitsSelect: document.getElementById('exits-select'),
            exitButtons: document.querySelectorAll('.exit-button'),
            directionText: document.getElementById('direction-text'),
            directionArrow: document.getElementById('direction-arrow'),
            requestDirection: document.getElementById('request-direction'),
            resetGame: document.getElementById('reset-game'), 
            historyList: document.getElementById('history-list'),
            voiceToggle: document.getElementById('voice-toggle'),
            hornToggle: document.getElementById('horn-toggle'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            themeSelector: document.getElementById('theme-selector-buttons'),
        };

        // --- FIREBASE & AUTH INITIALIZATION ---
        let db, auth;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            async function initializeAuth() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    showMessage(`Error signing in: ${error.message}`);
                }
            }
            initializeAuth();
        } 

        // --- MODAL CONTROL FUNCTIONS ---

        function openSettingsModal() {
            renderThemeSelector();
            ui.settingsModalOverlay.classList.add('open');
        }

        function closeSettingsModal() {
            ui.settingsModalOverlay.classList.remove('open');
        }

        // --- UTILITY FUNCTIONS ---

        function showMessage(text) {
             const messageBox = document.getElementById('status-message');
             document.getElementById('status-text').textContent = text;
             messageBox.style.display = 'flex';
        }
        
        function playAudio(key) {
            if (!audioFiles[key]) return Promise.resolve();
            const audioUrl = audioFiles[key];
            try {
                const audio = new Audio(audioUrl);
                
                return new Promise((resolve) => {
                    audio.onended = () => resolve();
                    audio.onerror = (e) => {
                        console.error(`Audio Load Error on file: ${audioUrl}`, e);
                        resolve();
                    };
                    
                    audio.play().then(() => {
                    }).catch(e => {
                        console.warn(`Audio playback blocked/failed for ${audioUrl}.`, e); 
                        resolve();
                    });
                });
            } catch (error) {
                console.error(`Critical error creating Audio object for ${audioUrl}:`, error);
                return Promise.resolve();
            }
        }
        
        async function playGpsVoice(direction) {
            if (!ui.voiceToggle.checked) return;

            isSpeaking = true;
            let audioKey = null;
            const simpleDir = direction.toLowerCase();

            if (simpleDir.includes('u-turn')) {
                // No specific U-turn audio provided
            } else if (simpleDir.includes('left')) {
                audioKey = 'left';
            } else if (simpleDir.includes('right')) {
                audioKey = 'right';
            } else if (simpleDir.includes('straight')) {
                audioKey = 'straight';
            } else if (simpleDir.includes('exit')) {
                const num = parseInt(simpleDir.match(/\d+/)?.[0], 10);
                if (num >= 1 && num <= 5) {
                    audioKey = `exit-${num}`;
                } 
            }

            if (audioKey) {
                await playAudio(audioKey);
            }
            isSpeaking = false;
        }


        // --- GAME LOGIC ---

        const rotationMap = {
            'straight': -90, 
            'left': -180,    
            'right': 0,      
            'u-turn': 90, 
        };

        function getDirectionIcon(direction) {
            const simpleDir = direction.toLowerCase();
            if (simpleDir.includes('u-turn')) return '<span class="text-purple-500">‚Ü©Ô∏è</span>'; 
            if (simpleDir.includes('left')) return '<span class="text-red-500">‚óÄÔ∏è</span>'; 
            if (simpleDir.includes('right')) return '<span class="text-green-500">‚ñ∂Ô∏è</span>'; 
            if (simpleDir.includes('straight') || simpleDir.includes('1st exit')) return '<span class="text-blue-500">‚¨ÜÔ∏è</span>'; 
            if (simpleDir.includes('exit')) return '<span class="text-yellow-500">‚Ü™Ô∏è</span>'; 
            return '‚Ä¢';
        }

        function getJunctionDirection() {
            const options = ['Turn left', 'Go straight', 'Turn right', 'Make a U-turn'];
            let newDirection;
            const [mostRecent, secondRecent] = recentDirections;
            
            // Check for forbidden sequence: same direction three times in a row
            const isForbiddenSequence = (mostRecent !== null && mostRecent === secondRecent);
            const forbiddenDirection = isForbiddenSequence ? mostRecent : null;
            
            do {
                newDirection = options[Math.floor(Math.random() * options.length)];
            } while (newDirection === forbiddenDirection);

            return newDirection;
        }

        function getRoundaboutDirection() {
            const numExits = exits; 
            
            const getOrdinal = (n) => {
                const s = ["th", "st", "nd", "rd"];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            };

            const options = Array.from({ length: numExits }, (_, i) => `${getOrdinal(i + 1)} Exit`);

            let newDirection;
            do {
                newDirection = options[Math.floor(Math.random() * options.length)];
            } while (newDirection === recentDirections[0]); 

            return newDirection;
        }

        function getRotation(direction) {
            const simpleDir = direction.toLowerCase();
            if (simpleDir.includes('u-turn')) return rotationMap['u-turn'];
            if (simpleDir.includes('left')) return rotationMap.left;
            if (simpleDir.includes('right')) return rotationMap.right;
            if (simpleDir.includes('straight')) return rotationMap.straight;

            if (simpleDir.includes('exit')) {
                const num = parseInt(simpleDir.match(/\d+/)?.[0], 10); 
                if (num > 0) {
                    const totalExits = exits; 
                    const angleStep = 360 / totalExits;
                    const baseOffset = -90; 
                    return baseOffset + angleStep * (num - 1);
                }
            }
            return rotationMap.straight; 
        }

        function generateDirection() {
            
            if (!hasStarted) {
                dismissSplashScreen(); 
            }

            if (isSpeaking) {
                if (ui.hornToggle.checked) {
                    playAudio('horn');
                }
                return; 
            }
            
            let direction;
            
            if (mode === 'junction') {
                direction = getJunctionDirection(); 
            } else {
                direction = getRoundaboutDirection();
            }

            recentDirections[1] = recentDirections[0];
            recentDirections[0] = direction;

            ui.directionText.textContent = direction;
            const rotation = getRotation(direction);
            ui.directionArrow.style.transform = `rotate(${rotation}deg)`;
            
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            history.unshift({ direction, timestamp });
            if (history.length > 5) history.pop(); 

            updateHistoryUI();
            playGpsVoice(direction);
            
            ui.requestDirection.textContent = 'üéØ Request Next Direction';
        }
        
        function dismissSplashScreen() {
            if (hasStarted) return;
            
            ui.splashScreen.style.opacity = 0;
            setTimeout(() => {
                ui.splashScreen.style.display = 'none';
            }, 400); 

            ui.appContainer.style.opacity = 1;

            playAudio('engine'); 
            hasStarted = true;
            ui.directionText.textContent = 'Drive Safe!';
        }


        function updateHistoryUI() {
            ui.historyList.innerHTML = history.map(item => 
                `<li class="flex justify-between border-b border-gray-100 dark:border-gray-700 pb-1">
                    <span class="font-semibold flex items-center gap-2">
                        ${getDirectionIcon(item.direction)} ${item.direction}
                    </span>
                    <span class="text-xs text-gray-400">${item.timestamp}</span>
                </li>`
            ).join('');

            if (history.length === 0) {
                 ui.historyList.innerHTML = '<li class="italic text-sm">No directions yet.</li>';
            }
        }

        function updateExitSelection(newExits) {
            exits = newExits;
            ui.exitsSelect.value = newExits; 
            
            ui.exitButtons.forEach(button => {
                button.classList.remove('exit-button-active');
                if (parseInt(button.dataset.exits, 10) === newExits) {
                    button.classList.add('exit-button-active');
                }
            });
            newGame();
        }

        function setMode(newMode) {
            mode = newMode;
            ui.modeJunction.classList.remove('active-mode');
            ui.modeRoundabout.classList.remove('active-mode');
            ui.roundaboutSettings.classList.add('hidden');

            if (mode === 'junction') {
                ui.modeJunction.classList.add('active-mode');
            } else {
                ui.modeRoundabout.classList.add('active-mode');
                ui.roundaboutSettings.classList.remove('hidden');
                updateExitSelection(exits); 
            }
            newGame();
        }

        function newGame() {
            isSpeaking = false;
            history = [];
            recentDirections = [null, null]; 
            ui.directionText.textContent = hasStarted ? 'Ready for a new route?' : 'Start Your Engine!';
            ui.directionArrow.style.transform = `rotate(0deg)`;
            ui.requestDirection.textContent = 'üéØ Request Direction';
            ui.requestDirection.disabled = false;
            updateHistoryUI();
            closeSettingsModal();
        }

        // --- THEME FUNCTIONS ---

        function toggleDarkMode(isDark) {
            isDarkMode = isDark;
            if (isDark) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('darkMode', isDark);
            // Re-render theme buttons to reflect potential dark mode changes
            renderThemeSelector(); 
        }
        
        function setColorTheme(themeKey) {
            colorTheme = themeKey;
            document.body.dataset.theme = themeKey;
            localStorage.setItem('colorTheme', themeKey);
            // Re-render theme buttons to show selection
            renderThemeSelector();
            
            // Re-apply button colors dynamically
            const settingsBtn = document.getElementById('settings-button');
            settingsBtn.style.color = getComputedStyle(document.body).getPropertyValue('--theme-accent').trim();
            settingsBtn.style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--theme-card-bg').trim();
        }

        function renderThemeSelector() {
            ui.themeSelector.innerHTML = ''; // Clear existing buttons
            
            Object.keys(themeColors).forEach(key => {
                const theme = themeColors[key];
                const isSelected = key === colorTheme;
                const button = document.createElement('button');
                
                // Get the calculated accent color
                const accentColor = getThemeAccentColor(key); 

                button.className = `theme-select-button p-2 rounded-lg font-semibold text-sm`;
                button.textContent = theme.name;
                button.dataset.themeKey = key;
                button.style.backgroundColor = accentColor;
                
                if (isSelected) {
                    button.classList.add('selected');
                }
                
                button.addEventListener('click', () => setColorTheme(key));
                ui.themeSelector.appendChild(button);
            });
        }
        
        /**
         * Load and apply settings from localStorage on startup.
         */
        function loadSettings() {
            // Theme
            const savedTheme = localStorage.getItem('colorTheme') || 'default';
            setColorTheme(savedTheme); 

            const savedDarkMode = localStorage.getItem('darkMode');
            isDarkMode = (savedDarkMode === 'true');
            ui.darkModeToggle.checked = isDarkMode;
            toggleDarkMode(isDarkMode); 

            // Voice Toggle
            const savedVoice = localStorage.getItem('voiceEnabled');
            const voiceEnabled = (savedVoice !== null) ? (savedVoice === 'true') : true; 
            ui.voiceToggle.checked = voiceEnabled;
            
            // Horn Toggle
            const savedHorn = localStorage.getItem('hornEnabled');
            const hornEnabled = (savedHorn !== null) ? (savedHorn === 'true') : true; 
            ui.hornToggle.checked = hornEnabled;
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        window.onload = function() {
            // 1. Load Settings
            loadSettings();
            
            // 2. Initial Game Setup
            setMode('junction');
        };

        // 3. Event Listeners
        ui.splashScreen.addEventListener('click', dismissSplashScreen);
        ui.settingsButton.addEventListener('click', openSettingsModal); // Open Modal
        
        ui.modeJunction.addEventListener('click', () => setMode('junction'));
        ui.modeRoundabout.addEventListener('click', () => setMode('roundabout'));

        ui.requestDirection.addEventListener('click', generateDirection); 
        
        ui.resetGame.addEventListener('click', newGame); // Reset button

        // Exit buttons listener
        ui.exitButtons.forEach(button => {
            button.addEventListener('click', () => {
                const newExits = parseInt(button.dataset.exits, 10);
                updateExitSelection(newExits);
            });
        });
        
        // Dark Mode Toggle Listener (Persist setting)
        ui.darkModeToggle.addEventListener('change', (e) => {
            toggleDarkMode(e.target.checked);
        });
        
        // Voice Toggle Listener (Persist setting)
        ui.voiceToggle.addEventListener('change', (e) => {
            localStorage.setItem('voiceEnabled', e.target.checked);
        });
        
        // Horn Toggle Listener (Persist setting)
        ui.hornToggle.addEventListener('change', (e) => {
            localStorage.setItem('hornEnabled', e.target.checked);
        });
        
    </script>
</body>
</html>
```eof

