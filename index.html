<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Direction Navigator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- THEME VARIABLE DEFINITIONS --- */
        :root, body[data-theme="default"]:not(.dark-mode) {
            --theme-bg-start: #A855F7; --theme-bg-end: #14B8A6; --theme-card-bg: white; --theme-text: #1F2937; --theme-accent: #EC4899; --theme-arrow: #14B8A6; --theme-secondary: #F3F4F6;
        }
        body[data-theme="default"].dark-mode {
            --theme-bg-start: #4C1D95; --theme-bg-end: #064E3B; --theme-card-bg: #1F2937; --theme-text: #E5E7EB; --theme-accent: #A855F7; --theme-arrow: #34D399; --theme-secondary: #374151;
        }
        body[data-theme="teal"]:not(.dark-mode) {
            --theme-bg-start: #00B8D4; --theme-bg-end: #00C853; --theme-card-bg: white; --theme-text: #1F2937; --theme-accent: #00B8D4; --theme-arrow: #00C853; --theme-secondary: #F3F4F6;
        }
        body[data-theme="teal"].dark-mode {
            --theme-bg-start: #006064; --theme-bg-end: #1B5E20; --theme-card-bg: #1F2937; --theme-text: #E5E7EB; --theme-accent: #80DEEA; --theme-arrow: #A5D6A7; --theme-secondary: #374151;
        }
        body[data-theme="blue"]:not(.dark-mode) {
            --theme-bg-start: #2196F3; --theme-bg-end: #FFEB3B; --theme-card-bg: white; --theme-text: #1F2937; --theme-accent: #2196F3; --theme-arrow: #FFEB3B; --theme-secondary: #F3F4F6;
        }
        body[data-theme="blue"].dark-mode {
            --theme-bg-start: #0D47A1; --theme-bg-end: #FFC107; --theme-card-bg: #1F2937; --theme-text: #E5E7EB; --theme-accent: #90CAF9; --theme-arrow: #FFECB3; --theme-secondary: #374151;
        }
        body[data-theme="trans"]:not(.dark-mode) {
            --theme-bg-start: #5BCEFA; --theme-bg-end: #F5A9B8; --theme-card-bg: white; --theme-text: #1F2937; --theme-accent: #F5A9B8; --theme-arrow: #5BCEFA; --theme-secondary: #F0F0F0;
        }
        body[data-theme="trans"].dark-mode {
            --theme-bg-start: #0A7DC3; --theme-bg-end: #CC5E78; --theme-card-bg: #1F2937; --theme-text: #FFFFFF; --theme-accent: #F5A9B8; --theme-arrow: #5BCEFA; --theme-secondary: #374151;
        }
        body[data-theme="nonbinary"]:not(.dark-mode) {
            --theme-bg-start: #FCF434; --theme-bg-end: #9C59D1; --theme-card-bg: white; --theme-text: #1F2937; --theme-accent: #9C59D1; --theme-arrow: #2C2C2C; --theme-secondary: #F0F0F0;
        }
        body[data-theme="nonbinary"].dark-mode {
            --theme-bg-start: #2C2C2C; --theme-bg-end: #9C59D1; --theme-card-bg: #1F2937; --theme-text: #FFFFFF; --theme-accent: #FCF434; --theme-arrow: #FFFFFF; --theme-secondary: #374151;
        }
        body[data-theme="pan"]:not(.dark-mode) {
            --theme-bg-start: #FF218C; --theme-bg-end: #21B1FF; --theme-card-bg: white; --theme-text: #1F2937; --theme-accent: #FFD800; --theme-arrow: #21B1FF; --theme-secondary: #F0F0F0;
        }
        body[data-theme="pan"].dark-mode {
            --theme-bg-start: #9C1045; --theme-bg-end: #10549C; --theme-card-bg: #1F2937; --theme-text: #E5E7EB; --theme-accent: #FFD800; --theme-arrow: #FF218C; --theme-secondary: #374151;
        }

        /* --- BASE STYLES --- */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 16px; 
            transition: background 0.5s ease, color 0.5s ease;
            background: linear-gradient(135deg, var(--theme-bg-start) 0%, var(--theme-bg-end) 50%, var(--theme-bg-end) 100%);
        }

        .card { 
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-out;
            background-color: var(--theme-card-bg); 
            color: var(--theme-text); 
        }

        body.dark-mode .card h2, body.dark-mode .card label, body.dark-mode .card span { color: var(--theme-text); }
        
        .arrow-container { width: 100px; height: 100px; margin: 20px auto; }
        #direction-arrow {
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-origin: 50% 50%;
            fill: var(--theme-arrow);
        }
        
        #request-direction { 
            background-color: var(--theme-accent);
            color: white;
            box-shadow: none; 
        }
        
        #stuck-button {
            background-color: #EF4444; color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #stuck-button:hover { background-color: #DC2626; }
        
        .mode-button { 
            background-color: rgba(255, 255, 255, 0.3); color: white; transition: all 0.2s;
        }
        .active-mode {
            background-color: var(--theme-accent) !important; color: white !important;
        }
        
        #settings-button, #leaderboard-button { 
            background-color: var(--theme-card-bg); color: var(--theme-accent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .reset-button { background-color: var(--theme-secondary); color: var(--theme-text); }
        
        body.dark-mode .mode-button { background-color: rgba(31, 41, 55, 0.7); color: #D1D5DB; }
        body.dark-mode #settings-button, body.dark-mode #leaderboard-button { background-color: var(--theme-secondary); color: var(--theme-accent); }
        body.dark-mode .exit-button, body.dark-mode .voice-mode-button { background-color: #4B5563; color: white; }
        
        .exit-button.exit-button-active, .voice-mode-button.voice-mode-button-active {
            background-color: var(--theme-arrow) !important; color: white !important; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transform: scale(1.05);
        }
        body.dark-mode .exit-button.exit-button-active, body.dark-mode .voice-mode-button.voice-mode-button-active { 
            background-color: var(--theme-arrow) !important; color: #1F2937 !important; 
        }
        
        /* Splash Screen */
        .splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); color: white; z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; cursor: pointer;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: opacity 0.4s ease;
        }
        .splash-screen-content {
            position: relative; background-color: rgba(255, 255, 255, 0.15);
            padding: 2.5rem 1.5rem; border-radius: 2rem; max-width: 90%; margin: 24px;
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.5); border: 3px solid var(--theme-accent);
        }
        .welcome-title {
            font-size: 3rem; font-weight: 900; line-height: 1.1; margin-bottom: 1rem;
            color: var(--theme-arrow); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center; gap: 1rem;
        }
        .instructions-header {
            font-size: 1.2rem; font-weight: 700; color: var(--theme-accent); margin-top: 1.5rem; margin-bottom: 0.5rem;
        }
        .instruction-item { font-size: 1rem; margin-bottom: 0.4rem; padding: 0 1rem; color: #E5E7EB; }
        .click-to-start {
            margin-top: 2rem; font-size: 1.5rem; font-weight: 800; color: #FBBF24;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 50; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease; display: flex; justify-content: center; align-items: center;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        /* Slide Panel for Settings/Leaderboard */
        .slide-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 80%;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 60; border-top-left-radius: 2rem; border-top-right-radius: 2rem;
            background-color: var(--theme-card-bg); color: var(--theme-text);
        }
        .modal-overlay.open .slide-panel { transform: translateY(0); }
        
        @media (min-width: 640px) {
            .slide-panel {
                width: 400px; right: 0; left: auto; top: 0; height: 100%; max-height: 100%;
                border-radius: 0; border-top-left-radius: 2rem; transform: translateX(100%);
            }
            .modal-overlay.open .slide-panel { transform: translateX(0); }
        }

        /* Game Over Modal Specifics */
        .center-modal {
            background-color: var(--theme-card-bg);
            color: var(--theme-text);
            padding: 2rem;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
        }
        .modal-overlay.open .center-modal { transform: scale(1); }

        #settings-button { position: fixed; top: 1rem; right: 1rem; z-index: 40; }
        #leaderboard-button { position: fixed; top: 1rem; left: 1rem; z-index: 40; }
        
        .theme-select-button {
            transition: transform 0.1s ease, box-shadow 0.2s ease; color: white !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); 
        }
        .theme-select-button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .theme-select-button.selected {
            border: 3px solid var(--theme-accent); transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
    </style>
</head>
<body data-theme="default">
    
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-screen-content">
            <div class="welcome-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                GPS Training Hub
            </div>
            <p class="text-lg text-gray-300 mb-4">Master quick direction changes without stress.</p>
            
            <div class="instructions-header">HOW TO PLAY:</div>
            <div class="instruction-item">1. **Tap Request** for your driving command.</div>
            <div class="instruction-item">2. **Stuck?** Tap "I'm Stuck" to end your run.</div>
            <div class="instruction-item">3. **Save Score** to the leaderboard.</div>
            <div class="click-to-start">TAP ANYWHERE TO START YOUR ENGINE!</div>
        </div>
    </div>

    <!-- Leaderboard Button -->
    <button id="leaderboard-button" class="p-3 rounded-full hover:opacity-80 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
    </button>

    <!-- Settings Button -->
    <button id="settings-button" class="p-3 rounded-full hover:opacity-80 transition duration-150">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09z"></path>
        </svg>
    </button>
    
    <!-- Main App Content -->
    <div id="app" class="w-full max-w-xl opacity-0 transition-opacity duration-500">
        
        <!-- Mode Selector -->
        <div class="mode-selector mb-6 flex flex-col gap-4 sm:flex-row mt-12">
            <button id="mode-junction" class="mode-button flex-1 py-3 px-6 font-bold rounded-2xl shadow-lg transition duration-200 hover:opacity-70" data-mode="junction">
                üöó At Junction
            </button>
            <button id="mode-roundabout" class="mode-button flex-1 py-3 px-6 font-bold rounded-2xl shadow-lg transition duration-200 hover:opacity-70" data-mode="roundabout">
                üõû In Roundabout
            </button>
        </div>

        <!-- Roundabout Exits Input -->
        <div id="roundabout-settings" class="card p-4 mb-6 hidden">
            <label class="block font-semibold mb-3">Select the number of exits:</label>
            <div id="exit-buttons" class="flex justify-between space-x-2">
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="2">2</button>
                <button class="exit-button w-1/5 py-2 exit-button-active bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="3">3</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="4">4</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="5">5</button>
                <button class="exit-button w-1/5 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-exits="6">6</button>
            </div>
            <input type="hidden" id="exits-select" value="3">
        </div>

        <!-- Main Direction Card -->
        <div id="direction-card" class="card text-center mb-6 p-6">
            <p id="direction-text" class="text-3xl sm:text-4xl font-extrabold my-4 h-12 flex items-center justify-center">
                Start Your Engine!
            </p>

            <div class="arrow-container">
                <svg id="direction-arrow" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" transform="rotate(0)">
                    <path d="M16.01 11H4c-1.1 0-2 .9-2 2s.9 2 2 2h12.01v3L21 13l-4.99-4v3z" />
                </svg>
            </div>

            <!-- Main Action Button -->
            <button id="request-direction" class="w-full py-5 mt-4 text-white font-black text-2xl rounded-2xl shadow-xl transition duration-200 hover:opacity-90 active:scale-[0.98] focus:outline-none focus:ring-4" style="--tw-ring-color: var(--theme-accent);">
                üéØ Request Direction
            </button>
            
            <!-- STUCK BUTTON -->
            <button id="stuck-button" class="w-full py-3 mt-3 font-bold text-lg rounded-xl shadow-lg transition duration-200 active:scale-[0.98] focus:outline-none focus:ring-4 ring-red-300">
                I'm Stuck / End Run
            </button>
        </div>
        
        <!-- Score and Level -->
        <div class="flex justify-between items-center mb-4 px-2">
             <div class="bg-white/80 dark:bg-black/40 rounded-lg px-4 py-2 shadow-sm border border-gray-200 dark:border-gray-600">
                <span class="text-sm font-bold uppercase text-gray-500 dark:text-gray-400">Score</span>
                <div id="score-display" class="text-2xl font-black text-gray-800 dark:text-white">0</div>
             </div>
             <div class="bg-white/80 dark:bg-black/40 rounded-lg px-4 py-2 shadow-sm border border-gray-200 dark:border-gray-600">
                <span class="text-sm font-bold uppercase text-gray-500 dark:text-gray-400">Moves</span>
                <div id="moves-display" class="text-2xl font-black" style="color: var(--theme-arrow)">0</div>
             </div>
        </div>

        <!-- Recent Directions History -->
        <div class="card p-4">
            <h2 class="text-xl font-bold mb-3 border-b pb-2">Recent Directions</h2>
            <ul id="history-list" class="space-y-2">
                <li class="italic text-sm">No directions yet.</li>
            </ul>
        </div>

        <!-- Status Message Box (Simple) -->
        <div id="status-message" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
            <div class="card p-6 text-center max-w-sm">
                <p id="status-text" class="text-xl font-semibold mb-4"></p>
                <button id="status-ok-button" class="bg-pink-500 text-white py-2 px-6 rounded-full font-bold hover:bg-pink-600 transition">OK</button>
            </div>
        </div>
        
        <!-- GAME OVER / NAME INPUT MODAL -->
        <div id="game-over-modal" class="modal-overlay">
            <div class="center-modal">
                <h2 class="text-3xl font-black mb-2" style="color: var(--theme-accent)">RUN COMPLETE!</h2>
                <div class="text-gray-500 mb-4 font-medium uppercase tracking-wide">Final Score</div>
                
                <div class="text-5xl font-black mb-6" id="final-score-display">0</div>
                
                <div class="mb-4 text-left">
                    <label class="block text-sm font-bold mb-2 ml-1">Pilot Name</label>
                    <input type="text" id="pilot-name-input" class="w-full p-3 rounded-xl border-2 border-gray-200 bg-gray-50 dark:bg-gray-800 dark:border-gray-600 focus:outline-none focus:border-pink-500 transition" placeholder="Enter your name" maxlength="15">
                </div>
                
                <button id="save-score-btn" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition mb-3">
                    üíæ Save Score
                </button>
                <button id="cancel-save-btn" class="w-full py-2 text-gray-500 font-semibold hover:text-gray-700 dark:hover:text-gray-300">
                    Skip Saving
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal-overlay" class="modal-overlay">
            <div id="settings-panel" class="slide-panel card p-6 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Game Settings</h2>
                    <button id="close-settings-x" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <button id="reset-game" class="reset-button w-full py-3 mb-6 font-semibold rounded-2xl shadow-md transition duration-200 hover:opacity-80 active:scale-[0.98]">
                    üîÑ Reset Game Data
                </button>

                <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Audio Mode</p>
                <div id="voice-mode-buttons" class="flex justify-between space-x-2 mt-3 mb-6">
                    <button class="voice-mode-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-mode="off">No Sound</button>
                    <button class="voice-mode-button flex-1 py-2 bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-mode="basic">Basic Sounds</button>
                    <button class="voice-mode-button flex-1 py-2 voice-mode-button-active bg-gray-100 font-bold rounded-xl transition duration-150 hover:opacity-80" data-mode="advanced">Advanced GPS</button>
                </div>
                <input type="hidden" id="voice-mode-select" value="advanced">

                <p class="font-bold border-t pt-4 border-gray-100 dark:border-gray-700">Appearance</p>
                <div class="flex flex-wrap gap-3 mt-3 mb-6" id="theme-selector-buttons">
                    <!-- Buttons will be generated by JS -->
                </div>

                <div class="flex justify-between items-center pt-4">
                    <label for="dark-mode-toggle" class="select-none">üåë Dark Mode</label>
                    <input type="checkbox" id="dark-mode-toggle" class="h-6 w-6 rounded text-pink-500 focus:ring-pink-500" style="--tw-ring-color: var(--theme-accent);">
                </div>
            </div>
        </div>

        <!-- Leaderboard Modal -->
        <div id="leaderboard-modal-overlay" class="modal-overlay">
            <div id="leaderboard-panel" class="slide-panel card p-6 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">üèÜ Leaderboard <span class="text-sm font-normal opacity-70">(Top 10)</span></h2>
                    <button id="close-leaderboard-x" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <ul id="leaderboard-list" class="space-y-2">
                    <li class="italic text-gray-500 text-center">Loading scores...</li>
                </ul>
            </div>
        </div>

    </div>

    <script type="module">
        
        // --- GAME STATE ---
        let mode = 'junction'; 
        let exits = 3; 
        let recentDirections = [null, null]; 
        let history = [];
        let hasStarted = false; 
        let colorTheme = 'default'; 
        let isDarkMode = false; 
        let isAudioAllowed = false; 
        let currentRunMoves = 0; 

        // --- AUDIO STATE ---
        let voiceMode = 'advanced'; 
        let audioContext = null;

        // --- AUDIO FILE MAPPING (LOCAL 'sounds' FOLDER) ---
        // PLEASE CREATE A FOLDER NAMED 'sounds' AND PUT YOUR MP3s THERE
        const LOCAL_SOUNDS_PATH = "sounds/";

        const advancedAudioFiles = {
            'engine': LOCAL_SOUNDS_PATH + 'engine-start.mp3',
            'horn': LOCAL_SOUNDS_PATH + 'beep.mp3', 
            'straight': LOCAL_SOUNDS_PATH + 'gps-straight.mp3',
            'left': LOCAL_SOUNDS_PATH + 'gps-left.mp3',
            'right': LOCAL_SOUNDS_PATH + 'gps-right.mp3',
            'exit-1': LOCAL_SOUNDS_PATH + 'gps-exit-1.mp3',
            'exit-2': LOCAL_SOUNDS_PATH + 'gps-exit-2.mp3',
            'exit-3': LOCAL_SOUNDS_PATH + 'gps-exit-3.mp3',
            'exit-4': LOCAL_SOUNDS_PATH + 'gps-exit-4.mp3',
            'exit-5': LOCAL_SOUNDS_PATH + 'gps-exit-5.mp3',
            'exit-6': LOCAL_SOUNDS_PATH + 'gps-exit-5.mp3' 
        };

        const themeColors = {
            'default': { name: 'Pink/Teal', dark: 'bg-purple-700', light: 'bg-pink-500' },
            'teal': { name: 'Teal/Green', dark: 'bg-green-700', light: 'bg-cyan-500' },
            'blue': { name: 'Blue/Yellow', dark: 'bg-yellow-700', light: 'bg-blue-500' },
            'trans': { name: 'Trans Pride', dark: 'bg-blue-700', light: 'bg-pink-300' },
            'nonbinary': { name: 'Non-Binary Pride', dark: 'bg-purple-700', light: 'bg-yellow-300' },
            'pan': { name: 'Pansexual Pride', dark: 'bg-pink-700', light: 'bg-blue-300' },
        };
        
        // --- UI ELEMENTS ---
        const ui = {
            splashScreen: document.getElementById('splashScreen'),
            appContainer: document.getElementById('app'),
            settingsButton: document.getElementById('settings-button'),
            leaderboardButton: document.getElementById('leaderboard-button'),
            settingsModalOverlay: document.getElementById('settings-modal-overlay'),
            leaderboardModalOverlay: document.getElementById('leaderboard-modal-overlay'),
            leaderboardList: document.getElementById('leaderboard-list'),
            closeSettingsX: document.getElementById('close-settings-x'),
            closeLeaderboardX: document.getElementById('close-leaderboard-x'),
            modeJunction: document.getElementById('mode-junction'),
            modeRoundabout: document.getElementById('mode-roundabout'),
            roundaboutSettings: document.getElementById('roundabout-settings'),
            exitsSelect: document.getElementById('exits-select'),
            exitButtons: document.getElementById('exit-buttons'),
            requestDirection: document.getElementById('request-direction'),
            stuckButton: document.getElementById('stuck-button'), 
            directionText: document.getElementById('direction-text'),
            directionArrow: document.getElementById('direction-arrow'),
            historyList: document.getElementById('history-list'),
            statusMessage: document.getElementById('status-message'),
            statusText: document.getElementById('status-text'),
            statusOkButton: document.getElementById('status-ok-button'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            themeSelectorButtons: document.getElementById('theme-selector-buttons'),
            resetGameButton: document.getElementById('reset-game'),
            voiceModeButtons: document.getElementById('voice-mode-buttons'),
            voiceModeSelect: document.getElementById('voice-mode-select'),
            scoreDisplay: document.getElementById('score-display'),
            movesDisplay: document.getElementById('moves-display'),
            // New Game Over Elements
            gameOverModal: document.getElementById('game-over-modal'),
            finalScoreDisplay: document.getElementById('final-score-display'),
            pilotNameInput: document.getElementById('pilot-name-input'),
            saveScoreBtn: document.getElementById('save-score-btn'),
            cancelSaveBtn: document.getElementById('cancel-save-btn')
        };
        
        // --- UTILITY FUNCTIONS ---
        
        function getThemeAccentColor(themeKey) {
            const tempDiv = document.createElement('div');
            tempDiv.setAttribute('data-theme', themeKey);
            if (document.body) document.body.appendChild(tempDiv);
            if (isDarkMode) { tempDiv.classList.add('dark-mode'); }
            const color = getComputedStyle(tempDiv).getPropertyValue('--theme-accent').trim();
            if (document.body) document.body.removeChild(tempDiv);
            return color;
        }

        function showStatusMessage(message) {
            ui.statusText.textContent = message;
            ui.statusMessage.style.display = 'flex';
        }
        
        function closeStatusMessage() {
            ui.statusMessage.style.display = 'none';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }
        function openModal(modalId) {
             document.getElementById(modalId).classList.add('open');
        }


        // --- AUDIO FUNCTIONS ---

        function initializeAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBasicSound(frequency = 440, duration = 0.2, type = 'sine') {
            if (voiceMode !== 'basic' || !isAudioAllowed || !audioContext) return; 

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playAdvancedSound(key) {
            if (voiceMode !== 'advanced' || !isAudioAllowed) return; 

            const audioUrl = advancedAudioFiles[key];
            if (!audioUrl) return;
            
            const audioPlayerLocal = new Audio(audioUrl); 
            audioPlayerLocal.play().catch(e => {
                console.error("Audio Play Error:", e);
                // Silent catch, mainly to handle path errors gracefully
            });
        }
        
        function playAudio(action, value = null) {
            if (voiceMode === 'off' || !isAudioAllowed) {
                return;
            } else if (voiceMode === 'advanced') {
                switch(action) {
                    case 'engine': playAdvancedSound('engine'); break;
                    case 'horn': playAdvancedSound('horn'); break;
                    case 'direction':
                        if (mode === 'junction') {
                            const directionKey = value.toLowerCase().replace(/\s/g, '').replace(/-/g, '');
                            if (directionKey.includes('slight')) {
                                playAdvancedSound(directionKey.includes('left') ? 'left' : 'right');
                            } else if (directionKey.includes('straight')) {
                                playAdvancedSound('straight');
                            } else if (directionKey.includes('left')) {
                                playAdvancedSound('left');
                            } else if (directionKey.includes('right')) {
                                playAdvancedSound('right');
                            }
                        } else if (mode === 'roundabout') {
                            const exitKey = `exit-${value}`;
                            playAdvancedSound(exitKey);
                        }
                        break;
                }
            } else if (voiceMode === 'basic') {
                switch(action) {
                    case 'engine': playBasicSound(200, 0.5, 'square'); break;
                    case 'horn': playBasicSound(800, 0.1, 'sawtooth'); break; 
                    case 'direction':
                        let freq = 440; 
                        if (mode === 'junction') {
                            if (value === 'Turn Left') freq = 300;
                            else if (value === 'Turn Right') freq = 600;
                            else if (value === 'U-Turn') freq = 100; 
                        }
                        playBasicSound(freq, 0.4, 'sine');
                        break;
                }
            }
        }


        // --- MAIN GAME LOGIC ---

        function generateJunctionDirection() {
            const uTurnOption = 'U-Turn';
            const standardOptions = ['Straight Ahead', 'Turn Left', 'Turn Right'];
            const [mostRecent, secondRecent] = recentDirections;
            const isForbidden = (direction) => mostRecent === direction && secondRecent === direction;

            if (Math.random() < 0.02) {
                if (!isForbidden(uTurnOption)) return uTurnOption; 
            }

            let availableOptions = standardOptions.filter(opt => !isForbidden(opt));
            if (availableOptions.length === 0) availableOptions = standardOptions;

            return availableOptions[Math.floor(Math.random() * availableOptions.length)];
        }

        function generateRoundaboutDirection() {
            const maxExits = parseInt(ui.exitsSelect.value);
            const exitNumber = Math.floor(Math.random() * maxExits) + 1;
            let directionText = `Take the ${exitNumber}${exitNumber === 1 ? 'st' : (exitNumber === 2 ? 'nd' : (exitNumber === 3 ? 'rd' : 'th'))} Exit`;
            return { text: directionText, exitNum: exitNumber };
        }
        
        function calculateRotation(directionText, exitNum) {
             const angles = { 'Straight Ahead': -90, 'Turn Left': -180, 'Turn Right': 0, 'U-Turn': 90 };
            
            if (mode === 'junction') {
                return angles[directionText] || 0;
            } else {
                 // GENERAL DIRECTION LOGIC FOR ROUNDABOUTS
                 // Exits roughly correspond to 90 degree increments
                 // 1st exit = Left (-180)
                 // 2nd exit = Straight (-90)
                 // 3rd exit = Right (0)
                 // 4th exit = U-Turn (90)
                 return -180 + ((exitNum - 1) * 90);
            }
        }

        function generateDirection() {
            // FIX: If user clicks Request before starting, ensure splash goes away and audio inits
            if (!hasStarted) {
                initializeAudioContext();
                isAudioAllowed = true;
                dismissSplashScreen(); 
            }
            
            let newDirectionText;
            let audioValue;
            
            if (mode === 'junction') {
                newDirectionText = generateJunctionDirection();
                audioValue = newDirectionText;
            } else {
                const result = generateRoundaboutDirection();
                newDirectionText = result.text;
                audioValue = result.exitNum;
            }

            recentDirections.unshift(newDirectionText);
            recentDirections.pop();

            ui.directionText.textContent = newDirectionText;
            const rotation = calculateRotation(newDirectionText, audioValue);
            ui.directionArrow.style.transform = `rotate(${rotation}deg)`;
            
            playAudio('direction', audioValue);
            
            currentRunMoves++;
            ui.movesDisplay.textContent = currentRunMoves;
            ui.scoreDisplay.textContent = parseInt(ui.scoreDisplay.textContent) + 10;
            
            updateHistory(newDirectionText);
            ui.requestDirection.textContent = 'üéØ Request Next Direction';
        }
        
        function handleStuck() {
            if (currentRunMoves === 0) {
                 showStatusMessage("You haven't started a run yet!");
                 return;
            }
            
            playAudio('horn');
            
            // Open Game Over Modal
            ui.finalScoreDisplay.textContent = currentRunMoves;
            ui.pilotNameInput.value = ''; // Clear previous input
            openModal('game-over-modal');
            
            // Focus input after small delay for animation
            setTimeout(() => ui.pilotNameInput.focus(), 100);
        }

        async function saveScore(score, name) {
            const pilotName = name.trim() || "Anonymous Pilot";
            const scoreData = {
                score: score,
                name: pilotName,
                timestamp: Date.now(),
                mode: mode
            };

            // Local Storage ONLY
            try {
                const localScores = JSON.parse(localStorage.getItem('gps_leaderboard') || '[]');
                localScores.push(scoreData);
                // Keep top 20 locally to be safe
                localScores.sort((a, b) => b.score - a.score);
                const trimmedScores = localScores.slice(0, 20);
                
                localStorage.setItem('gps_leaderboard', JSON.stringify(trimmedScores));
                console.log("Score saved locally!");
                showStatusMessage("Score Saved!");
            } catch (e) {
                console.error("Local save failed:", e);
                showStatusMessage("Could not save score.");
            }
        }

        function completeGameReset() {
            currentRunMoves = 0;
            ui.movesDisplay.textContent = '0';
            ui.scoreDisplay.textContent = '0'; // FIX: Reset score as well
            ui.directionText.textContent = "Run Ended. Ready for next?";
            ui.directionArrow.style.transform = `rotate(-90deg)`;
            closeModal('game-over-modal');
        }
        
        async function fetchLeaderboard() {
            ui.leaderboardList.innerHTML = '<li class="text-center animate-pulse">Loading...</li>';
            
            let scores = [];
            
            // Local Storage ONLY
            try {
                const localScores = JSON.parse(localStorage.getItem('gps_leaderboard') || '[]');
                scores = localScores;
            } catch (e) {
                console.error("Local fetch failed:", e);
            }
            
            // Render
            scores.sort((a, b) => b.score - a.score);
            const topScores = scores.slice(0, 10);
            
            ui.leaderboardList.innerHTML = '';
            if (topScores.length === 0) {
                ui.leaderboardList.innerHTML = '<li class="text-center italic opacity-70">No runs recorded yet. Get driving!</li>';
                return;
            }
            
            topScores.forEach((s, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-xl";
                li.innerHTML = `
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-sm w-5 text-center ${index < 3 ? 'text-yellow-500' : 'text-gray-400'}">#${index + 1}</span>
                            <span class="font-bold text-gray-800 dark:text-white truncate max-w-[120px]">${s.name || 'Anonymous'}</span>
                        </div>
                        <span class="text-xs text-gray-400 ml-7 capitalize">${s.mode}</span>
                    </div>
                    <span class="font-black text-xl" style="color: var(--theme-accent)">${s.score}</span>
                `;
                ui.leaderboardList.appendChild(li);
            });
        }

        // --- UI UPDATES (History) ---

        function updateHistory(newDirection) {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            history.unshift({ time: timestamp, direction: newDirection });
            if (history.length > 5) history.pop();
            renderHistory();
        }

        function renderHistory() {
            ui.historyList.innerHTML = '';
            if (history.length === 0) {
                ui.historyList.innerHTML = '<li class="italic text-sm">No directions yet.</li>';
                return;
            }
            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'text-sm font-medium';
                li.innerHTML = `<span class="font-bold text-xs p-1 rounded-md" style="background-color: var(--theme-secondary);">[${item.time}]</span> ${item.direction}`;
                ui.historyList.appendChild(li);
            });
        }
        
        function resetGame() {
            history = [];
            currentRunMoves = 0;
            recentDirections = [null, null];
            ui.scoreDisplay.textContent = '0'; 
            ui.movesDisplay.textContent = '0';
            ui.directionText.textContent = "Game Reset. Tap Request.";
            ui.directionArrow.style.transform = `rotate(-90deg)`; 
            renderHistory();
        }

        // --- HANDLERS ---

        function dismissSplashScreen() {
            if (hasStarted) return;
            ui.splashScreen.style.opacity = 0;
            setTimeout(() => { ui.splashScreen.style.display = 'none'; }, 400); 
            ui.appContainer.style.opacity = 1;
            playAudio('engine'); 
            hasStarted = true;
            ui.directionText.textContent = 'Drive Safe!';
        }

        function handleRequestDirection() {
            generateDirection();
        }

        function handleModeChange(newMode) {
            mode = newMode;
            ui.modeJunction.classList.remove('active-mode');
            ui.modeRoundabout.classList.remove('active-mode');
            
            if (mode === 'junction') {
                ui.modeJunction.classList.add('active-mode');
                ui.roundaboutSettings.classList.add('hidden');
                ui.directionText.textContent = "Junction Mode Ready";
            } else {
                ui.modeRoundabout.classList.add('active-mode');
                ui.roundaboutSettings.classList.remove('hidden');
                ui.directionText.textContent = "Roundabout Mode Ready";
            }
            if (!hasStarted) {
                // If they change mode before starting, we don't start yet.
            }
        }
        
        function handleExitSelection(event) {
            const button = event.target.closest('.exit-button');
            if (!button) return;
            ui.exitButtons.querySelectorAll('.exit-button').forEach(btn => btn.classList.remove('exit-button-active'));
            button.classList.add('exit-button-active');
            exits = parseInt(button.dataset.exits);
            ui.exitsSelect.value = exits; 
        }
        
        function handleVoiceModeSelection(event) {
            const button = event.target.closest('.voice-mode-button');
            if (!button) return;
            ui.voiceModeButtons.querySelectorAll('.voice-mode-button').forEach(btn => btn.classList.remove('voice-mode-button-active'));
            button.classList.add('voice-mode-button-active');
            voiceMode = button.dataset.mode;
            ui.voiceModeSelect.value = voiceMode;
            localStorage.setItem('voiceMode', voiceMode);
        }

        function openSettingsModal() {
            generateThemeButtons(); 
            openModal('settings-modal-overlay');
        }

        function toggleDarkMode(isDark) {
            isDarkMode = isDark;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
            generateThemeButtons();
        }

        function changeTheme(themeKey) {
            colorTheme = themeKey;
            document.body.setAttribute('data-theme', themeKey);
            localStorage.setItem('colorTheme', themeKey);
            generateThemeButtons();
        }
        
        function generateThemeButtons() {
            ui.themeSelectorButtons.innerHTML = '';
            Object.keys(themeColors).forEach(key => {
                const colors = themeColors[key];
                const button = document.createElement('button');
                button.className = `theme-select-button py-2 px-4 rounded-xl font-bold transition duration-150 hover:opacity-80`;
                button.dataset.theme = key;
                button.textContent = colors.name;
                
                const lightColor = getThemeAccentColor(key); 
                button.style.backgroundColor = lightColor;
                
                if (key === colorTheme) {
                    button.classList.add('selected');
                }
                
                button.addEventListener('click', () => changeTheme(key));
                ui.themeSelectorButtons.appendChild(button);
            });
        }
        
        // --- INITIALIZATION ---

        function loadPreferences() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            ui.darkModeToggle.checked = savedDarkMode;
            toggleDarkMode(savedDarkMode);

            const savedTheme = localStorage.getItem('colorTheme') || 'default';
            changeTheme(savedTheme);
            
            const savedVoiceMode = localStorage.getItem('voiceMode') || 'advanced';
            voiceMode = savedVoiceMode;
            ui.voiceModeSelect.value = voiceMode;
            ui.voiceModeButtons.querySelectorAll('.voice-mode-button').forEach(btn => {
                btn.classList.toggle('voice-mode-button-active', btn.dataset.mode === voiceMode);
            });
            
            handleModeChange('junction');
            generateThemeButtons(); 
        }

        function setupEventListeners() {
            // FIX: Ensure click is required for Splash Screen
            ui.splashScreen.addEventListener('click', () => {
                initializeAudioContext();
                isAudioAllowed = true;
                dismissSplashScreen();
            });

            ui.requestDirection.addEventListener('click', handleRequestDirection);
            
            ui.modeJunction.addEventListener('click', () => handleModeChange('junction'));
            ui.modeRoundabout.addEventListener('click', () => handleModeChange('roundabout'));
            
            ui.exitButtons.addEventListener('click', handleExitSelection);
            
            ui.settingsButton.addEventListener('click', openSettingsModal);
            ui.resetGameButton.addEventListener('click', () => {
                resetGame();
                closeModal('settings-modal-overlay');
            });
            
            // STUCK BUTTON
            ui.stuckButton.addEventListener('click', handleStuck);
            
            // SAVE SCORE BUTTONS
            ui.saveScoreBtn.addEventListener('click', () => {
                saveScore(currentRunMoves, ui.pilotNameInput.value);
                completeGameReset();
            });
            ui.cancelSaveBtn.addEventListener('click', () => {
                completeGameReset();
            });
            
            // LEADERBOARD BUTTON
            ui.leaderboardButton.addEventListener('click', () => {
                fetchLeaderboard();
                openModal('leaderboard-modal-overlay');
            });
            
            // MODAL CLOSE BUTTONS
            ui.settingsModalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'settings-modal-overlay') closeModal('settings-modal-overlay');
            });
            ui.leaderboardModalOverlay.addEventListener('click', (e) => {
                if (e.target.id === 'leaderboard-modal-overlay') closeModal('leaderboard-modal-overlay');
            });
            
            ui.closeSettingsX.addEventListener('click', () => closeModal('settings-modal-overlay'));
            ui.closeLeaderboardX.addEventListener('click', () => closeModal('leaderboard-modal-overlay'));
            
            ui.statusOkButton.addEventListener('click', closeStatusMessage);

            ui.darkModeToggle.addEventListener('change', (e) => toggleDarkMode(e.target.checked));
            ui.voiceModeButtons.addEventListener('click', handleVoiceModeSelection);
        }
        
        window.onload = function() {
            loadPreferences();
            setupEventListeners();
            // Removed any setTimeout logic here to ensure click is required
        };

    </script>
</body>
</html>
